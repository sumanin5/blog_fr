# ============================================================
# 阶段 1: 构建阶段 (build-stage)
# ============================================================
# 使用 Node.js 22 作为基础镜像，用于编译前端代码
# AS build-stage 给这个阶段命名，后面可以引用
FROM node:22 AS build-stage

# 设置工作目录
# 后续所有命令都在 /app 目录下执行
WORKDIR /app

# ============================================================
# 先只复制 package.json 和 package-lock.json
# ============================================================
# 为什么不直接 COPY . /app？
# 因为 Docker 是按层缓存的：
#   - 如果 package*.json 没变，这一层和下一层(npm install)会使用缓存
#   - npm install 很慢，缓存能节省大量时间
#   - 只有源代码变了，才需要重新构建后面的步骤
COPY package*.json /app/

# 安装依赖
# 这一步很慢（可能几分钟），所以放在源代码复制之前
# 只要 package.json 不变，这一层就会被缓存
RUN npm install

# ============================================================
# 复制所有源代码
# ============================================================
# 现在才复制源代码，因为源代码经常变动
# 这样改代码时，上面的 npm install 层仍然是缓存的
COPY ./ /app/

# ============================================================
# 构建参数：API 地址
# ============================================================
# ARG 是构建时的参数，从 docker-compose.yml 传入
# 这个地址会被"烘焙"进最终的 JS 文件中
# 注意：这不是运行时环境变量，构建后就无法修改！
ARG VITE_API_URL=${VITE_API_URL}

# 执行构建命令
# npm run build 会：
#   1. 编译 TypeScript/JSX
#   2. 打包所有 JS 文件
#   3. 压缩代码
#   4. 输出到 /app/dist 目录
RUN npm run build


# ============================================================
# 阶段 2: 生产阶段 (production)
# ============================================================
# 使用 Nginx 作为基础镜像
# 为什么不继续用 Node.js？
#   - Node.js 镜像很大（约 1GB），Nginx 很小（约 20MB）
#   - 前端构建后只是静态文件，不需要 Node.js 运行
#   - Nginx 专门用来提供静态文件，性能更好
FROM nginx:1

# ============================================================
# 从构建阶段复制编译好的文件
# ============================================================
# --from=build-stage 表示从第一阶段复制
# /app/dist/ 是 Vite 构建输出的目录
# /usr/share/nginx/html 是 Nginx 默认的静态文件目录
COPY --from=build-stage /app/dist/ /usr/share/nginx/html

# ============================================================
# 复制 Nginx 配置文件
# ============================================================
# 主配置：处理路由、代理等
COPY ./nginx.conf /etc/nginx/conf.d/default.conf

# 额外配置：处理后端 API 404 的情况
COPY ./nginx-backend-not-found.conf /etc/nginx/extra-conf.d/backend-not-found.conf

# ============================================================
# 说明：为什么没有 CMD？
# ============================================================
# Nginx 官方镜像已经有默认的 CMD: ["nginx", "-g", "daemon off;"]
# 所以不需要再写，容器启动时会自动运行 Nginx

