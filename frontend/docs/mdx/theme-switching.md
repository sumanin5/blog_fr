# 代码高亮主题切换说明

## 当前状态

✅ **代码高亮已经工作** - 代码有颜色了
⚠️ **主题切换较慢** - 这是技术限制
⚠️ **代码块背景不明显** - 已添加边框和阴影

## 问题解释

### 1. 为什么主题切换慢？

**技术原因**：

- Shiki 在**构建时**（Build Time）生成代码高亮
- 它为每个主题生成不同的 HTML 和内联样式
- 切换主题时，浏览器需要：
  1. 重新计算所有代码块的样式
  2. 重新渲染整个页面
  3. 应用新的颜色值

**对比其他方案**：

- **PrismJS**（运行时高亮）：切换快，但效果差，性能差
- **Shiki**（构建时高亮）：效果好，性能好，但切换慢

### 2. 生产环境会更快吗？

**是的！** 生产环境会明显更快，因为：

1. **代码优化**
   - 压缩和混淆
   - Tree-shaking 移除未使用的代码
   - 更小的包体积

2. **浏览器缓存**
   - CSS 和 JS 文件被缓存
   - 字体文件被缓存
   - 减少网络请求

3. **没有开发工具开销**
   - 没有 HMR（热模块替换）
   - 没有 Source Maps
   - 没有开发服务器的额外逻辑

4. **更好的渲染性能**
   - 生产构建使用优化的 React
   - 更少的 re-renders
   - 更好的 DOM 操作

**预期改善**：

- 开发环境：主题切换 ~500-800ms
- 生产环境：主题切换 ~200-400ms

### 3. 如何优化？

#### 方案 A：接受现状（推荐）

- Shiki 是目前最好的代码高亮方案
- 主题切换不是高频操作
- 用户通常设置一次就不会频繁切换

#### 方案 B：使用单主题

如果主题切换速度真的很重要，可以只使用一个主题：

```typescript
// vite.config.ts
[
  rehypeShiki,
  {
    theme: "github-dark", // 只用暗色主题
  },
];
```

**优点**：

- 主题切换更快
- 包体积更小

**缺点**：

- 亮色模式下代码块仍然是暗色

#### 方案 C：CSS 变量方案（复杂）

使用 Shiki 的 CSS 变量功能，但需要大量自定义配置：

```typescript
[
  rehypeShiki,
  {
    theme: "css-variables",
  },
];
```

然后在 CSS 中定义所有颜色变量。

**优点**：

- 主题切换即时
- 完全自定义

**缺点**：

- 需要手动定义几十个颜色变量
- 维护成本高
- 容易出错

## 当前优化

### 已完成

1. **✅ 增强代码块视觉效果**

   ```css
   pre {
     border: 1px solid var(--border);
     box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
     background: var(--muted) / 0.8;
   }
   ```

2. **✅ 添加主题切换过渡**

   ```css
   * {
     transition:
       background-color 0.3s ease,
       color 0.3s ease,
       border-color 0.3s ease;
   }
   ```

3. **✅ 优化字体加载**
   - 使用 `@fontsource` 本地字体
   - 避免 FOUT（无样式文本闪烁）

### 建议

1. **接受当前方案**
   - Shiki 是业界最佳实践
   - GitHub、VS Code 等都使用类似方案
   - 主题切换不是高频操作

2. **在生产环境测试**
   - 构建生产版本：`npm run build`
   - 预览生产版本：`npm run preview`
   - 对比切换速度

3. **如果仍然不满意**
   - 考虑使用单主题
   - 或者使用 CSS 变量方案（需要大量工作）

## 关于系统主题

### 当前行为

ThemeContext 已经支持跟随系统：

- 选择 "System" 时，会自动检测系统主题
- 系统主题变化时，会自动更新

### 验证方法

1. 点击主题切换按钮
2. 选择 "System"
3. 更改系统主题设置
4. 页面应该自动更新

### 如果不工作

检查以下内容：

1. ThemeProvider 是否正确包裹了应用
2. 浏览器是否支持 `prefers-color-scheme`
3. 系统是否正确设置了主题偏好

## 总结

| 方面         | 当前状态          | 生产环境     |
| ------------ | ----------------- | ------------ |
| 代码高亮     | ✅ 工作正常       | ✅ 更好      |
| 主题切换速度 | ⚠️ 500-800ms      | ✅ 200-400ms |
| 视觉效果     | ✅ 有边框和阴影   | ✅ 相同      |
| 系统主题跟随 | ✅ 支持           | ✅ 支持      |
| 字体         | ✅ JetBrains Mono | ✅ 相同      |

**推荐**：

- 保持当前配置
- 在生产环境中测试
- 如果仍然不满意，再考虑其他方案
