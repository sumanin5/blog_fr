# API æµ‹è¯•æ¨¡å—æ¦‚è§ˆ

è¿™ä¸ªç›®å½•åŒ…å«äº†æ‰€æœ‰ API ç›¸å…³çš„æµ‹è¯•ï¼ŒæŒ‰åŠŸèƒ½æ¨¡å—ç»„ç»‡ã€‚

## ğŸ“ ç›®å½•ç»“æ„

```
tests/api/
â”œâ”€â”€ conftest.py              # æµ‹è¯•é…ç½®å’Œå·¥å…·å‡½æ•°
â”œâ”€â”€ users/                   # ç”¨æˆ·æ¨¡å—æµ‹è¯•
â”‚   â”œâ”€â”€ __init__.py         # æ¨¡å—è¯´æ˜
â”‚   â”œâ”€â”€ test_auth.py        # è®¤è¯åŠŸèƒ½æµ‹è¯•
â”‚   â”œâ”€â”€ test_profile.py     # ç”¨æˆ·èµ„æ–™ç®¡ç†æµ‹è¯•
â”‚   â””â”€â”€ test_permissions.py # æƒé™ç®¡ç†æµ‹è¯•
â””â”€â”€ README.md               # æœ¬æ–‡ä»¶
```

## ğŸ§ª æµ‹è¯•å†…å®¹æ¦‚è§ˆ

### ç”¨æˆ·è®¤è¯æµ‹è¯• (`users/test_auth.py`)

- âœ… **ç”¨æˆ·æ³¨å†ŒåŠŸèƒ½** (7 ä¸ªæµ‹è¯•)
  - æˆåŠŸæ³¨å†Œ
  - é‡å¤ç”¨æˆ·å/é‚®ç®±é”™è¯¯
  - æ•°æ®éªŒè¯é”™è¯¯
  - ç¼ºå°‘å¿…éœ€å­—æ®µ
- âœ… **ç”¨æˆ·ç™»å½•åŠŸèƒ½** (6 ä¸ªæµ‹è¯•)
  - æˆåŠŸç™»å½•ï¼ˆç”¨æˆ·å/é‚®ç®±ï¼‰
  - é”™è¯¯å¯†ç /ä¸å­˜åœ¨ç”¨æˆ·
  - éæ¿€æ´»ç”¨æˆ·ç™»å½•
  - ç©ºå‡­æ®éªŒè¯
- âœ… **Token éªŒè¯** (2 ä¸ªæµ‹è¯•)
  - Token æ ¼å¼éªŒè¯
  - æ— æ•ˆ token è®¿é—®

### ç”¨æˆ·èµ„æ–™ç®¡ç†æµ‹è¯• (`users/test_profile.py`)

- âœ… **è·å–ç”¨æˆ·ä¿¡æ¯** (4 ä¸ªæµ‹è¯•)
  - è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
  - ç®¡ç†å‘˜è·å–æŒ‡å®šç”¨æˆ·ä¿¡æ¯
  - æƒé™éªŒè¯å’Œé”™è¯¯å¤„ç†
- âœ… **æ›´æ–°ç”¨æˆ·èµ„æ–™** (7 ä¸ªæµ‹è¯•)
  - å®Œæ•´/éƒ¨åˆ†æ›´æ–°åŠŸèƒ½
  - æ•°æ®å†²çªæ£€æŸ¥
  - æƒé™éªŒè¯
- âœ… **åˆ é™¤ç”¨æˆ·è´¦å·** (4 ä¸ªæµ‹è¯•)
  - åˆ é™¤å½“å‰ç”¨æˆ·
  - ç®¡ç†å‘˜åˆ é™¤æŒ‡å®šç”¨æˆ·
  - æƒé™éªŒè¯

### ç”¨æˆ·æƒé™ç®¡ç†æµ‹è¯• (`users/test_permissions.py`)

- âœ… **è§’è‰²æƒé™éªŒè¯** (3 ä¸ªæµ‹è¯•)
  - æ™®é€šç”¨æˆ·æƒé™èŒƒå›´
  - ç®¡ç†å‘˜æƒé™èŒƒå›´
  - è¶…çº§ç®¡ç†å‘˜æƒé™èŒƒå›´
- âœ… **ç”¨æˆ·åˆ—è¡¨è®¿é—®æƒé™** (3 ä¸ªæµ‹è¯•)
  - ä¸åŒè§’è‰²è®¿é—®æƒé™
  - åˆ†é¡µåŠŸèƒ½
  - è¿‡æ»¤åŠŸèƒ½
- âœ… **è·¨ç”¨æˆ·æ“ä½œæƒé™** (4 ä¸ªæµ‹è¯•)
  - ç”¨æˆ·é—´è®¿é—®é™åˆ¶
  - æƒé™è¾¹ç•Œæµ‹è¯•
  - è§’è‰²æ··åˆåœºæ™¯

## ğŸ·ï¸ æµ‹è¯•æ ‡è®°

ä½¿ç”¨ pytest æ ‡è®°æ¥åˆ†ç±»å’Œç­›é€‰æµ‹è¯•ï¼š

```bash
# æŒ‰æ¨¡å—è¿è¡Œ
pytest -m "users" -v                    # æ‰€æœ‰ç”¨æˆ·æ¨¡å—æµ‹è¯•
pytest -m "permissions" -v              # æ‰€æœ‰æƒé™ç›¸å…³æµ‹è¯•
pytest -m "integration" -v              # æ‰€æœ‰é›†æˆæµ‹è¯•

# ç»„åˆæ ‡è®°
pytest -m "users and permissions" -v    # ç”¨æˆ·æƒé™æµ‹è¯•
pytest -m "users and integration" -v    # ç”¨æˆ·é›†æˆæµ‹è¯•

# æŒ‰æ–‡ä»¶è¿è¡Œ
pytest tests/api/users/test_auth.py -v
pytest tests/api/users/test_profile.py -v
pytest tests/api/users/test_permissions.py -v
```

## ğŸ› ï¸ æµ‹è¯•å·¥å…·å’Œé…ç½®

### æµ‹è¯•é…ç½® (`conftest.py`)

- **HTTP å®¢æˆ·ç«¯**: `async_client` - å¼‚æ­¥ HTTP æµ‹è¯•å®¢æˆ·ç«¯
- **ç”¨æˆ· Fixtures**:
  - `normal_user`, `admin_user`, `superadmin_user` - ä¸åŒæƒé™ç”¨æˆ·
  - `inactive_user` - éæ¿€æ´»ç”¨æˆ·
  - `multiple_users`, `mixed_role_users` - æ‰¹é‡æµ‹è¯•æ•°æ®
- **è®¤è¯ Fixtures**: `*_token_headers` - å„ç”¨æˆ·çš„è®¤è¯å¤´
- **æµ‹è¯•æ•°æ®**: `TestData` - é¢„å®šä¹‰çš„æµ‹è¯•æ•°æ®å¸¸é‡
- **æ–­è¨€å·¥å…·**: `assert_*` - ç»Ÿä¸€çš„å“åº”æ ¼å¼éªŒè¯å‡½æ•°

### æµ‹è¯•æ•°æ®å¸¸é‡ (`TestData`)

```python
# æœ‰æ•ˆæ•°æ®
TestData.VALID_REGISTER_DATA
TestData.VALID_UPDATE_DATA
TestData.VALID_LOGIN_DATA

# æ— æ•ˆæ•°æ®
TestData.INVALID_REGISTER_DATA
TestData.INVALID_UPDATE_DATA
TestData.INVALID_LOGIN_DATA

# çŠ¶æ€ç å’Œé”™è¯¯ç 
TestData.StatusCodes.OK, CREATED, BAD_REQUEST, etc.
TestData.ErrorCodes.USER_NOT_FOUND, INVALID_CREDENTIALS, etc.
```

### æ–­è¨€å·¥å…·å‡½æ•°

```python
assert_error_response(data, expected_code)     # éªŒè¯é”™è¯¯å“åº”æ ¼å¼
assert_user_response(data, expected_user)      # éªŒè¯ç”¨æˆ·å“åº”æ ¼å¼
assert_user_list_response(data, count)         # éªŒè¯ç”¨æˆ·åˆ—è¡¨å“åº”æ ¼å¼
assert_token_response(data)                    # éªŒè¯Tokenå“åº”æ ¼å¼
```

## ğŸ“Š æµ‹è¯•ç»Ÿè®¡

- **æ€»æµ‹è¯•æ•°**: çº¦ 40 ä¸ªæµ‹è¯•
- **è¦†ç›–åŠŸèƒ½**: ç”¨æˆ·è®¤è¯ã€èµ„æ–™ç®¡ç†ã€æƒé™æ§åˆ¶
- **æµ‹è¯•ç±»å‹**: é›†æˆæµ‹è¯•ä¸ºä¸»
- **é”™è¯¯åœºæ™¯**: å…¨é¢è¦†ç›–å„ç§é”™è¯¯æƒ…å†µ
- **æƒé™æµ‹è¯•**: å®Œæ•´çš„è§’è‰²æƒé™éªŒè¯

## ğŸš€ è¿è¡Œæµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰APIæµ‹è¯•
pytest tests/api/ -v

# è¿è¡Œç”¨æˆ·æ¨¡å—æµ‹è¯•
pytest tests/api/users/ -v

# è¿è¡Œç‰¹å®šæµ‹è¯•æ–‡ä»¶
pytest tests/api/users/test_auth.py -v

# è¿è¡Œå¸¦è¦†ç›–ç‡æŠ¥å‘Š
pytest tests/api/ --cov=app --cov-report=html

# è¿è¡Œå¹¶ç”Ÿæˆè¯¦ç»†æŠ¥å‘Š
pytest tests/api/ -v --tb=short --durations=10
```

## ğŸ”§ ç»´æŠ¤è¯´æ˜

1. **æ·»åŠ æ–°æµ‹è¯•**: æŒ‰åŠŸèƒ½åˆ†ç±»æ”¾å…¥å¯¹åº”çš„æµ‹è¯•æ–‡ä»¶
2. **æ›´æ–°æµ‹è¯•æ•°æ®**: ä¿®æ”¹ `conftest.py` ä¸­çš„ `TestData` ç±»
3. **æ·»åŠ æ–°æ–­è¨€**: åœ¨ `conftest.py` ä¸­æ·»åŠ æ–°çš„ `assert_*` å‡½æ•°
4. **æ›´æ–°æ ‡è®°**: åœ¨ `pyproject.toml` ä¸­æ³¨å†Œæ–°çš„ pytest æ ‡è®°
5. **æ–‡æ¡£æ›´æ–°**: åŠæ—¶æ›´æ–°æœ¬ README æ–‡ä»¶å’Œå„æ¨¡å—çš„ docstring
