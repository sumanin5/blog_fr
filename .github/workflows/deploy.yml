name: Deploy to Aliyun ECS

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  # é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡é…ç½®
  ACR_REGISTRY: crpi-qvig00qix6yo4bi5.cn-hangzhou.personal.cr.aliyuncs.com
  ACR_NAMESPACE: blog-project
  # éƒ¨ç½²æœåŠ¡å™¨é…ç½®
  DEPLOY_PATH: /home/tomy/blog_fr

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. ç™»å½•é˜¿é‡Œäº‘é•œåƒæœåŠ¡
      - name: Login to Aliyun ACR
        uses: aliyun/acr-login@v1
        with:
          login-server: ${{ env.ACR_REGISTRY }}
          region-id: cn-hangzhou
          access-key-id: ${{ secrets.ALIYUN_AK_ID }}
          access-key-secret: ${{ secrets.ALIYUN_AK_SECRET }}

      # 2. æ„å»ºå¹¶æ¨é€ Backend é•œåƒ
      - name: Build and Push Backend
        run: |
          IMAGE_TAG=${{ env.ACR_REGISTRY }}/${{ env.ACR_NAMESPACE }}/blog-backend
          # è¿›å…¥å­ç›®å½•æ„å»ºï¼Œä¿æŒä¸Šä¸‹æ–‡çº¯å‡€
          cd backend
          docker build -t $IMAGE_TAG:${{ github.sha }} -t $IMAGE_TAG:latest .
          docker push $IMAGE_TAG:${{ github.sha }}
          docker push $IMAGE_TAG:latest

      # 3. æ„å»ºå¹¶æ¨é€ Frontend é•œåƒ
      - name: Build and Push Frontend
        run: |
          IMAGE_TAG=${{ env.ACR_REGISTRY }}/${{ env.ACR_NAMESPACE }}/blog-frontend
          # è¿›å…¥å­ç›®å½•æ„å»º
          cd frontend
          # ä¼ é€’æ„å»ºå‚æ•°
          docker build \
            --build-arg NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }} \
            -t $IMAGE_TAG:${{ github.sha }} -t $IMAGE_TAG:latest .
          docker push $IMAGE_TAG:${{ github.sha }}
          docker push $IMAGE_TAG:latest

      # 4. æ„å»ºå¹¶æ¨é€ Caddy é•œåƒ
      - name: Build and Push Caddy
        run: |
          IMAGE_TAG=${{ env.ACR_REGISTRY }}/${{ env.ACR_NAMESPACE }}/blog-caddy
          cd caddy
          docker build -t $IMAGE_TAG:${{ github.sha }} -t $IMAGE_TAG:latest .
          docker push $IMAGE_TAG:${{ github.sha }}
          docker push $IMAGE_TAG:latest

      # 5. è¿œç¨‹éƒ¨ç½²
      - name: Deploy to ECS via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.ECS_IP }}
          username: ${{ secrets.ECS_USER }}
          password: ${{ secrets.ECS_PASSWORD }}
          script: |
            # åœæ­¢è„šæœ¬è‹¥é‡é”™åˆ™é€€å‡º
            set -e

            echo "ğŸš€ å¼€å§‹éƒ¨ç½²..."
            cd ${{ env.DEPLOY_PATH }}

            # ç™»å½• ACR (ä½¿ç”¨ Secrets ä¸­çš„ä¿¡æ¯ï¼Œæˆ–è€…æœåŠ¡å™¨ä¸Šå·²ç» login è¿‡)
            # å»ºè®®åœ¨æœåŠ¡å™¨ä¸Šé…ç½®å¥½é•¿æœŸæœ‰æ•ˆçš„è¿™ç±»ç™»å½•ï¼Œæˆ–è€…æ¯æ¬¡éƒ½ç™»ï¼š
            echo "${{ secrets.ALIYUN_AK_SECRET }}" | docker login ${{ env.ACR_REGISTRY }} --username "${{ secrets.ALIYUN_AK_ID }}" --password-stdin

            # æ‹‰å–æœ€æ–°é•œåƒ
            echo "ğŸ“¥ æ‹‰å–æœ€æ–°é•œåƒ..."
            docker compose pull

            # é‡å¯æœåŠ¡ (åªæ›´æ–°å˜åŒ–çš„å®¹å™¨)
            echo "ğŸ”„ é‡å¯æœåŠ¡..."
            docker compose up -d

            # æ¸…ç†æ— ç”¨é•œåƒ
            echo "ğŸ§¹ æ¸…ç†æ—§é•œåƒ..."
            docker image prune -f

            echo "âœ… éƒ¨ç½²å®Œæˆï¼"
