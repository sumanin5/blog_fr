name: Deploy to Aliyun ECS

# éƒ¨ç½²å‰æ£€æŸ¥æ¸…å•:
# 1. åœ¨é˜¿é‡Œäº‘ ACR æ§åˆ¶å°åˆ›å»ºä»¥ä¸‹ä»“åº“:
#    - blog-project/blog-backend
#    - blog-project/blog-frontend
#    - blog-project/blog-caddy
# 2. ç¡®ä¿ AccessKey æœ‰ AliyunContainerRegistryFullAccess æƒé™
# 3. é…ç½® GitHub Secrets: ALIYUN_AK_ID, ALIYUN_AK_SECRET, ECS_IP, ECS_USER, ECS_PASSWORD, NEXT_PUBLIC_API_URL

on:
  push:
    branches: ["main"]
  workflow_dispatch:

env:
  # é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡é…ç½®
  ACR_REGISTRY: crpi-qvig00qix6yo4bi5.cn-hangzhou.personal.cr.aliyuncs.com
  ACR_NAMESPACE: blog-project
  # éƒ¨ç½²æœåŠ¡å™¨é…ç½®
  DEPLOY_PATH: /home/tomy/blog_fr

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. ç™»å½•é˜¿é‡Œäº‘é•œåƒæœåŠ¡
      # æ–¹å¼1: ä½¿ç”¨ AccessKey (æœ‰æ—¶ä¼šæœ‰è®¤è¯é—®é¢˜)
      # æ–¹å¼2: ä½¿ç”¨å›ºå®šå¯†ç  (æ¨èï¼Œæ›´ç¨³å®š)
      - name: Login to Aliyun ACR
        run: |
          echo "å°è¯•ç™»å½•é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡..."
          echo "Registry: ${{ env.ACR_REGISTRY }}"
          echo "Namespace: ${{ env.ACR_NAMESPACE }}"

          # æ–¹å¼1: AccessKey ç™»å½• (å¦‚æœæœ‰è®¤è¯é—®é¢˜ï¼Œæ³¨é‡Šæ‰è¿™éƒ¨åˆ†)
          # echo "${{ secrets.ALIYUN_AK_SECRET }}" | docker login \
          #   ${{ env.ACR_REGISTRY }} \
          #   --username "${{ secrets.ALIYUN_AK_ID }}" \
          #   --password-stdin

          # æ–¹å¼2: å›ºå®šå¯†ç ç™»å½• (æ¨è)
          echo "${{ secrets.ACR_PASSWORD }}" | docker login \
            ${{ env.ACR_REGISTRY }} \
            --username "${{ secrets.ACR_USERNAME }}" \
            --password-stdin

          echo "âœ“ ç™»å½•æˆåŠŸ"

      # 2. æ„å»ºå¹¶æ¨é€ Backend é•œåƒ
      - name: Build and Push Backend
        run: |
          IMAGE_TAG=${{ env.ACR_REGISTRY }}/${{ env.ACR_NAMESPACE }}/blog-backend
          echo "æ„å»º Backend é•œåƒ: $IMAGE_TAG"
          cd backend
          docker build -t $IMAGE_TAG:${{ github.sha }} -t $IMAGE_TAG:latest .
          echo "æ¨é€ Backend é•œåƒåˆ° ACR..."
          docker push $IMAGE_TAG:${{ github.sha }} && echo "âœ“ æ¨é€ SHA æ ‡ç­¾æˆåŠŸ" || echo "âš  æ¨é€ SHA æ ‡ç­¾å¤±è´¥"
          docker push $IMAGE_TAG:latest && echo "âœ“ æ¨é€ latest æ ‡ç­¾æˆåŠŸ" || echo "âš  æ¨é€ latest æ ‡ç­¾å¤±è´¥"

      # 3. æ„å»ºå¹¶æ¨é€ Frontend é•œåƒ
      - name: Build and Push Frontend
        run: |
          IMAGE_TAG=${{ env.ACR_REGISTRY }}/${{ env.ACR_NAMESPACE }}/blog-frontend
          echo "æ„å»º Frontend é•œåƒ: $IMAGE_TAG"
          cd frontend
          # ä¼ é€’æ„å»ºå‚æ•°
          docker build \
            --build-arg NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }} \
            -t $IMAGE_TAG:${{ github.sha }} -t $IMAGE_TAG:latest .
          echo "æ¨é€ Frontend é•œåƒåˆ° ACR..."
          docker push $IMAGE_TAG:${{ github.sha }} && echo "âœ“ æ¨é€ SHA æ ‡ç­¾æˆåŠŸ" || echo "âš  æ¨é€ SHA æ ‡ç­¾å¤±è´¥"
          docker push $IMAGE_TAG:latest && echo "âœ“ æ¨é€ latest æ ‡ç­¾æˆåŠŸ" || echo "âš  æ¨é€ latest æ ‡ç­¾å¤±è´¥"

      # 4. æ„å»ºå¹¶æ¨é€ Caddy é•œåƒ
      - name: Build and Push Caddy
        run: |
          IMAGE_TAG=${{ env.ACR_REGISTRY }}/${{ env.ACR_NAMESPACE }}/blog-caddy
          echo "æ„å»º Caddy é•œåƒ: $IMAGE_TAG"
          cd caddy
          docker build -t $IMAGE_TAG:${{ github.sha }} -t $IMAGE_TAG:latest .
          echo "æ¨é€ Caddy é•œåƒåˆ° ACR..."
          docker push $IMAGE_TAG:${{ github.sha }} && echo "âœ“ æ¨é€ SHA æ ‡ç­¾æˆåŠŸ" || echo "âš  æ¨é€ SHA æ ‡ç­¾å¤±è´¥"
          docker push $IMAGE_TAG:latest && echo "âœ“ æ¨é€ latest æ ‡ç­¾æˆåŠŸ" || echo "âš  æ¨é€ latest æ ‡ç­¾å¤±è´¥"

      # 5. è¿œç¨‹éƒ¨ç½²
      - name: Deploy to ECS via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.ECS_IP }}
          username: ${{ secrets.ECS_USER }}
          password: ${{ secrets.ECS_PASSWORD }}
          script: |
            # åœæ­¢è„šæœ¬è‹¥é‡é”™åˆ™é€€å‡º
            set -e

            echo "ğŸš€ å¼€å§‹éƒ¨ç½²..."

            # ç¡®ä¿é¡¹ç›®ç›®å½•å­˜åœ¨
            if [ ! -d "${{ env.DEPLOY_PATH }}" ]; then
              echo "ğŸ“ é¡¹ç›®ç›®å½•ä¸å­˜åœ¨ï¼Œæ­£åœ¨å…‹éš†..."
              cd /home/${{ secrets.ECS_USER }}
              git clone https://github.com/${{ github.repository }}.git blog_fr
            fi

            cd ${{ env.DEPLOY_PATH }}

            # æ‹‰å–æœ€æ–°ä»£ç 
            echo "ğŸ“¥ æ‹‰å–æœ€æ–°ä»£ç ..."
            git fetch origin
            git reset --hard origin/main

            # ç¡®ä¿ .env æ–‡ä»¶å­˜åœ¨
            if [ ! -f ".env" ]; then
              echo "âš ï¸  è­¦å‘Š: .env æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¯·æ‰‹åŠ¨åˆ›å»ºï¼"
              echo "æç¤º: cp .env.production.template .env"
              exit 1
            fi

            # ç™»å½• ACR
            echo "ğŸ” ç™»å½•é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡..."
            # æ–¹å¼1: AccessKey (å¦‚æœæœ‰è®¤è¯é—®é¢˜ï¼Œæ³¨é‡Šæ‰è¿™éƒ¨åˆ†)
            # echo "${{ secrets.ALIYUN_AK_SECRET }}" | docker login ${{ env.ACR_REGISTRY }} --username "${{ secrets.ALIYUN_AK_ID }}" --password-stdin

            # æ–¹å¼2: å›ºå®šå¯†ç  (æ¨è)
            echo "${{ secrets.ACR_PASSWORD }}" | docker login ${{ env.ACR_REGISTRY }} --username "${{ secrets.ACR_USERNAME }}" --password-stdin

            # æ‹‰å–æœ€æ–°é•œåƒ
            echo "ğŸ“¥ æ‹‰å–æœ€æ–°é•œåƒ..."
            docker compose pull

            # é‡å¯æœåŠ¡ (åªæ›´æ–°å˜åŒ–çš„å®¹å™¨)
            echo "ğŸ”„ é‡å¯æœåŠ¡..."
            docker compose up -d

            # æ¸…ç†æ— ç”¨é•œåƒ
            echo "ğŸ§¹ æ¸…ç†æ—§é•œåƒ..."
            docker image prune -f

            echo "âœ… éƒ¨ç½²å®Œæˆï¼"
